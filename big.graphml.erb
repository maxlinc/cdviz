<?xml version="1.0" ?>
<% rails_apps = ['site', 'admin', 'store'] %>
<graphml xmlns="http://graphml.graphdrawing.org/xmlns">
    <key id="name" for="node" attr.name="name" attr.type="string"></key>
    <key id="type" for="node" attr.name="type" attr.type="string"></key>
    <key id="template" for="node" attr.name="template" attr.type="string"></key>
    <key id="_label" for="edge" attr.name="_label" attr.type="string"></key>
    <key id="timestamp" for="edge" attr.name="timestamp" attr.type="int"></key>
    <graph id="G" edgedefault="directed">
<% rails_apps.each do | app | %>
        <!-- <%=app %> nodes -->
        <node id="<%=app %>_pipeline">
            <data key="name"><%=app %></data>
            <data key="type">pipeline</data>
            <data key="template">rails_app</data>
        </node>
        <node id="<%=app %>_commit_stage">
            <data key="name">commit</data>
            <data key="type">stage</data>
        </node>
        <node id="<%=app %>_publish_stage">
            <data key="name">publish</data>
            <data key="type">stage</data>
        </node>
        <node id="<%=app %>_unit_job">
            <data key="name">unit</data>
            <data key="type">job</data>
        </node>
        <node id="<%=app %>_acceptance_job">
            <data key="name">acceptance</data>
            <data key="type">job</data>
        </node>
        <node id="<%=app %>_publish_job">
            <data key="name">publish</data>
            <data key="type">job</data>
        </node>

        <!-- <%=app %> pipeline edges -->
        <edge source="<%=app %>_pipeline" target="<%=app %>_commit_stage">
            <data key="_label">contains</data>
        </edge>
        <edge source="<%=app %>_pipeline" target="<%=app %>_publish_stage">
            <data key="_label">contains</data>
        </edge>
        <edge source="<%=app %>_commit_stage" target="<%=app %>_unit_job">
            <data key="_label">contains</data>
        </edge>
        <edge source="<%=app %>_commit_stage" target="<%=app %>_acceptance_job">
            <data key="_label">contains</data>
        </edge>
        <edge source="<%=app %>_publish_stage" target="<%=app %>_publish_job">
            <data key="_label">contains</data>
        </edge>
        <edge source="<%=app %>_commit_stage" target="<%=app %>_publish_stage">
            <data key="_label">triggers</data>
        </edge>
        <edge source="<%=app %>_publish_stage" target="aggregate_aggregate_stage">
            <data key="_label">triggers</data>
        </edge>
<% end %>

        <!-- Aggregate nodes -->
        <node id="aggregate_pipeline">
            <data key="name">aggregate</data>
            <data key="type">pipeline</data>
            <!-- no template -->
        </node>
        <node id="aggregate_aggregate_stage">
            <data key="name">aggregate</data>
            <data key="type">stage</data>
        </node>
        <node id="aggregate_aggregate_job">
            <data key="name">aggregate</data>
            <data key="type">job</data>
        </node>

        <!-- Aggregate edges -->
        <edge source="aggregate_pipeline" target="aggregate_aggregate_stage">
            <data key="_label">contains</data>
        </edge>
        <edge source="aggregate_aggregate_stage" target="aggregate_aggregate_job">
            <data key="_label">contains</data>
        </edge>
        <edge source="aggregate_aggregate_stage" target="qa_deploy_stage">
            <data key="_label">triggers</data>
        </edge>

<% while deployments.size > 0 %>
<%   environment = deployments.shift %>
<%   next_environment = deployments[0] %>
        <!--  Environment: <%= environment %>-->
        <!--  Next: <%= next_environment %>-->
        <!-- <%= environment %> nodes -->
        <node id="<%= environment %>_pipeline">
            <data key="name"><%= environment %></data>
            <data key="type">pipeline</data>
            <data key="template">deploy</data>
        </node>
        <node id="<%= environment %>_deploy_stage">
            <data key="name">deploy</data>
            <data key="type">stage</data>
        </node>
        <node id="<%= environment %>_deploy_job">
            <data key="name">deploy</data>
            <data key="type">job</data>
        </node>
        <node id="<%= environment %>_test_stage">
            <data key="name">test</data>
            <data key="type">stage</data>
        </node>
        <node id="<%= environment %>_test_job">
            <data key="name">test</data>
            <data key="type">job</data>
        </node>

        <!-- <%= environment %> pipeline edges -->
        <edge source="<%= environment %>_pipeline" target="<%= environment %>_deploy_stage">
            <data key="_label">contains</data>
        </edge>
        <edge source="<%= environment %>_pipeline" target="<%= environment %>_test_stage">
            <data key="_label">contains</data>
        </edge>
        <edge source="<%= environment %>_deploy_stage" target="<%= environment %>_deploy_job">
            <data key="_label">contains</data>
        </edge>
        <edge source="<%= environment %>_test_stage" target="<%= environment %>_test_job">
            <data key="_label">contains</data>
        </edge>
        <edge source="<%= environment %>_deploy_stage" target="<%= environment %>_test_stage">
            <data key="_label">triggers</data>
        </edge>
        <% unless next_environment.nil? %>
        <edge source="<%= environment %>_test_stage" target="<%= next_environment %>_deploy_stage">
            <data key="_label">triggers</data>
        </edge>
        <% end %>
<% end %>

        <% require 'faker' # here comes the crazy data!
            users = []
            10.times do
                user = {
                    :name => Faker::Name.name,
                    :email => Faker::Internet.email
                }
                users << user
            end
        %>
        <% users.each do |user| %>
        <node id="user_<%= user[:name] %>">
            <data key="name"><%= user[:name] %></data>
            <data key="type">user</data>
        </node>
        <% end %>

        <% 5.times do %>
        <% commit_hash = Faker::Lorem.characters 64 %>
        <% user = users.sample %>
        <node id="commit_<%= commit_hash %>">
            <data key="name"><%= commit_hash %></data>
            <data key="type">commit</data>
        </node>

        <edge source="user_<%= user[:name] %>" target="commit_<%= commit_hash %>">
            <data key="_label">commited</data>
        </edge>

        <% app = rails_apps.sample %>
        <edge source="commit_<%= commit_hash %>" target="<%= app %>_pipeline">
            <data key="_label">built</data>
        </edge>
        <% end %>
    </graph>
</graphml>
